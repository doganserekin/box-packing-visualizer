(function(){"use strict";function S(){return Math.random().toString(36).substr(2,9)}function g(r,e,s){return r*e*s}function b(r){const e=[r.widthCm,r.depthCm,r.heightCm],s=new Set,o=[];return[[e[0],e[1],e[2]],[e[0],e[2],e[1]],[e[1],e[0],e[2]],[e[1],e[2],e[0]],[e[2],e[0],e[1]],[e[2],e[1],e[0]]].forEach(f=>{const n=f.join("x");s.has(n)||(s.add(n),o.push({w:f[0],d:f[1],h:f[2],rot:[0,0,0]}))}),o}function k(r,e,s,o,c,f){if(r<0||e<0||s<0||r+o.w>c.widthCm||e+o.h>c.heightCm||s+o.d>c.depthCm)return!1;for(const n of f){const i=r<n.x+n.size.w&&r+o.w>n.x,h=e<n.y+n.size.h&&e+o.h>n.y,a=s<n.z+n.size.d&&s+o.d>n.z;if(i&&h&&a)return!1}return!0}function v(r,e,s,o,c,f){if(c===0)return!0;const n=r,i=r+s,h=e,a=e+o,l=f.filter(t=>t.y+t.size.h===c).map(t=>({x0:t.x,x1:t.x+t.size.w,z0:t.z,z1:t.z+t.size.d})).filter(t=>t.x1>n&&t.x0<i&&t.z1>h&&t.z0<a);if(l.length===0)return!1;const d=Array.from(new Set([n,i,...l.flatMap(t=>[Math.max(n,Math.min(i,t.x0)),Math.max(n,Math.min(i,t.x1))])])).sort((t,u)=>t-u),m=Array.from(new Set([h,a,...l.flatMap(t=>[Math.max(h,Math.min(a,t.z0)),Math.max(h,Math.min(a,t.z1))])])).sort((t,u)=>t-u);for(let t=0;t<d.length-1;t++)for(let u=0;u<m.length-1;u++){const C=d[t],w=d[t+1],x=m[u],z=m[u+1];if((w-C)*(z-x)<=0)continue;const M=(C+w)/2,R=(x+z)/2;if(!l.some(p=>M>=p.x0&&M<=p.x1&&R>=p.z0&&R<=p.z1))return!1}return!0}function y(r,e){const s=[],o=["#ff6b6b","#ffd166","#06d6a0","#118ab2","#ef476f","#f78c6b","#8e7dbe","#00c2ff","#ffa600","#2a9d8f"],c=[...r].sort((f,n)=>g(n.widthCm,n.depthCm,n.heightCm)-g(f.widthCm,f.depthCm,f.heightCm));for(let f=0;f<c.length;f++){const n=c[f];let i=null;const h=a=>{for(let l=0;l<=e.widthCm;l+=2)for(let d=0;d<=e.depthCm;d+=2){const m=b(n);for(const t of m)if(k(l,a,d,{w:t.w,d:t.d,h:t.h},e,s)&&v(l,d,t.w,t.d,a,s))return{id:S(),productId:n.id,x:l,y:a,z:d,rotation:t.rot,size:{w:t.w,d:t.d,h:t.h},color:o[f%o.length]}}return null};if(i=h(0),!i)for(const a of s){const l=a.y+a.size.h;if(i=h(l),i)break}if(!i)return null;s.push(i)}return s}function E(r,e){console.log("[WORKER] Starting packing for",e.length,"products");const s=[...r].sort((o,c)=>g(o.widthCm,o.depthCm,o.heightCm)-g(c.widthCm,c.depthCm,c.heightCm));for(const o of s){const c=y(e,o);if(c)return console.log("[WORKER] Found fitting box:",o),{box:o,placed:c}}return null}self.onmessage=r=>{console.log("[WORKER] Received message:",r.data);const{type:e,boxes:s,products:o}=r.data;if(e==="pack"){console.log("[WORKER] Starting packing for",o.length,"products");const c=E(s,o);console.log("[WORKER] Packing result:",c),self.postMessage(c)}}})();
